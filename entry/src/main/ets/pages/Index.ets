
import router from '@ohos.router'; //
type ButtonPressCallback = (label: string) => void;

@Component
struct CalculatorButton {
  label: string = '0';
  btnBackgroundColor: Color = 0xFFD2D2D2;
  fontColor: Color = Color.Black;
  onPress: ButtonPressCallback = (label: string) => {};

  build() {
    Button(this.label)
      .width('100%')
      .height('100%')
      .fontSize(40)
      .fontColor(this.fontColor)
      .borderRadius(100)
      .margin(5)


      .stateStyles({
        // æ­£å¸¸çŠ¶æ€ (Normal)
        normal: {
          .backgroundColor(this.btnBackgroundColor)
        },
        // æŒ‰ä¸‹çŠ¶æ€ (Pressed) - å˜ä¸ºæ›´æ·±çš„é¢œè‰²
        pressed: {
          .backgroundColor(this.getPressedColor())
        }
      })


      .animation({
        duration: 200, // åŠ¨ç”»æŒç»­ 200ms
        curve: Curve.EaseOut // ä½¿ç”¨å‡é€Ÿæ›²çº¿ï¼Œæ¨¡æ‹Ÿç‰©ç†æ‰©æ•£æ„Ÿ
      })


      .clickEffect({ level: ClickEffectLevel.LIGHT, scale: 0.95 })

      .onClick(() => {
        this.onPress(this.label);
      })
  }

  // ğŸ¨ è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—â€œæŒ‰ä¸‹â€æ—¶çš„æ·±è‰²é¢œè‰²
  getPressedColor(): ResourceColor {
    // è¿™é‡Œæ‰‹åŠ¨å®šä¹‰ä¸‰ç§æŒ‰é’®å¯¹åº”çš„â€œæ·±è‰²ç‰ˆâ€
    if (this.btnBackgroundColor == 0xFFFF9500) {
      return 0xFFCC7700; //
    } else if (this.btnBackgroundColor == 0xFFAFAFAF) {
      return 0xFF888888; //
    } else {
      return 0xFF1A1A1A; //
    }
  }
}

@Entry
@Component
struct CalculatorPage {
  // --- çŠ¶æ€å˜é‡ ---
  @State displayValue: string = '0'; // æ˜¾ç¤ºå±ä¸Šçš„æ•°å€¼
  @State firstOperand: number | null = null; // å­˜å‚¨ç¬¬ä¸€ä¸ªæ“ä½œæ•°
  @State operator: string | null = null; // å­˜å‚¨å½“å‰çš„è¿ç®—ç¬¦ (ä¾‹å¦‚ +)
  @State isWaitingForSecondOperand: boolean = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨ç­‰å¾…è¾“å…¥ç¬¬äºŒä¸ªæ•°å­—

  private buttonLayout: string[][] = [
    ['ğŸ¤“','AC', '+/-', '%', 'Ã·'],
    ['7', '8', '9', 'Ã—'],
    ['4', '5', '6', '-'],
    ['1', '2', '3', '+'],
    ['0', '.', '=']
  ];
  // æ–°å¢ï¼šå¤„ç†é¡µé¢è·³è½¬çš„å‡½æ•°
  handleNavigate() {
    try {
      router.pushUrl({
        url: 'pages/scienceCalculator'
      }, router.RouterMode.Single);

      console.info('[Router] Successfully attempted navigation to Science Calculator.');

    }
    catch(err) {
      const error = err as Error;
      console.error(`[Router] Navigation failed: ${error.message}`);
    }
  }
  // --- æ ¸å¿ƒé€»è¾‘å¤„ç† ---
  onButtonPress(label: string) {
    console.info(`[Calculator] ç”¨æˆ·ç‚¹å‡»äº†æŒ‰é’®: ${label}`);
    // å¢åŠ è·³è½¬é€»è¾‘
    if (label === 'ğŸ¤“') {
      this.handleNavigate();
      return;
    }
    if (label === 'AC') {
      this.handleClear();
    } else if (label === '+/-') {
      this.handleSign();
    } else if (label === '%') {
      this.handlePercent();
    } else if (['+', '-', 'Ã—', 'Ã·'].includes(label)) {
      this.handleOperator(label);
    } else if (label === '=') {
      this.handleEqual();
    } else {
      // å‰©ä¸‹çš„éƒ½æ˜¯æ•°å­—æˆ–å°æ•°ç‚¹
      this.handleNumber(label);
    }
  }

  // 1. å¤„ç†æ•°å­—å’Œå°æ•°ç‚¹
  handleNumber(label: string) {
    if (this.isWaitingForSecondOperand) {
      // å¦‚æœæŒ‰ä¸‹äº†è¿ç®—ç¬¦ï¼Œæ­£åœ¨ç­‰å¾…ç¬¬äºŒä¸ªæ•°å­—ï¼Œé‚£ä¹ˆæ–°è¾“å…¥çš„æ•°å­—åº”è¯¥è¦†ç›–æ˜¾ç¤ºå±
      this.displayValue = label === '.' ? '0.' : label;
      this.isWaitingForSecondOperand = false;
    } else {
      // å¦åˆ™æ˜¯è¿½åŠ æ¨¡å¼
      if (label === '.') {
        if (!this.displayValue.includes('.')) {
          this.displayValue += '.';
        }
      } else {
        // å¦‚æœå½“å‰æ˜¯0ä¸”ä¸æ˜¯å°æ•°ï¼Œç›´æ¥æ›¿æ¢ï¼Œå¦åˆ™è¿½åŠ 
        if (this.displayValue === '0') {
          this.displayValue = label;
        } else {
          // é™åˆ¶é•¿åº¦é˜²æ­¢æº¢å‡º
          if(this.displayValue.length < 15) {
            this.displayValue += label;
          }
        }
      }
    }
  }

  // 2. å¤„ç†è¿ç®—ç¬¦ (+ - Ã— Ã·)
  handleOperator(nextOperator: string) {
    const inputValue = parseFloat(this.displayValue);

    // å¦‚æœå·²ç»æœ‰ç¬¬ä¸€ä¸ªæ•°å’Œè¿ç®—ç¬¦ï¼Œä¸”ä¸æ˜¯åˆšåˆšæŒ‰ä¸‹è¿ç®—ç¬¦ï¼ˆè¿ç»­è¿ç®—é€»è¾‘ï¼Œå¦‚ 1+2+...ï¼‰
    if (this.firstOperand !== null && this.operator && !this.isWaitingForSecondOperand) {
      const result = this.calculate(this.firstOperand, inputValue, this.operator);
      this.displayValue = String(result);
      this.firstOperand = result; // å°†ç»“æœä½œä¸ºä¸‹ä¸€æ¬¡è¿ç®—çš„ç¬¬ä¸€ä¸ªæ•°
    } else {
      // ç¬¬ä¸€æ¬¡æŒ‰ä¸‹è¿ç®—ç¬¦
      this.firstOperand = inputValue;
    }

    this.operator = nextOperator;
    this.isWaitingForSecondOperand = true; // å‡†å¤‡æ¥æ”¶ä¸‹ä¸€ä¸ªæ•°å­—
  }

  // 3. å¤„ç†ç­‰å· (=)
  handleEqual() {
    if (this.operator && this.firstOperand !== null) {
      const inputValue = parseFloat(this.displayValue);
      const result = this.calculate(this.firstOperand, inputValue, this.operator);

      this.displayValue = String(result);
      // è¿ç®—ç»“æŸï¼Œé‡ç½®çŠ¶æ€ï¼Œä½†ä¿ç•™æ˜¾ç¤ºç»“æœ
      this.firstOperand = null;
      this.operator = null;
      this.isWaitingForSecondOperand = true; //ä»¥æ­¤æ ‡è®°è¿ç®—ç»“æŸï¼Œä¸‹æ¬¡è¾“å…¥æ•°å­—ä¼šç›´æ¥è¦†ç›–
    }
  }

  // 4. æ‰§è¡Œå…·ä½“è¿ç®—
  calculate(first: number, second: number, op: string): number {
    console.info(`[Calculator] å¼€å§‹è®¡ç®—: ${first} ${op} ${second}`);
    let result = 0;
    switch (op) {
      case '+': result = first + second; break;
      case '-': result = first - second; break;
      case 'Ã—': result = first * second; break;
      case 'Ã·': result = second === 0 ? 0 : first / second; break; // ç®€å•é˜²é™¤ä»¥0
    }
    // å¤„ç†æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜ (ç®€å•çš„å¤„ç†æ–¹å¼)
    console.info(`[Calculator] è®¡ç®—ç»“æœ: ${result}`);
    return parseFloat(result.toPrecision(12));
  }

  // 5. å¤„ç†æ¸…é›¶ (AC)
  handleClear() {
    this.displayValue = '0';
    this.firstOperand = null;
    this.operator = null;
    this.isWaitingForSecondOperand = false;
  }

  // 6. å¤„ç†æ­£è´Ÿå· (+/-)
  handleSign() {
    const value = parseFloat(this.displayValue);
    this.displayValue = String(value * -1);
  }

  // 7. å¤„ç†ç™¾åˆ†æ¯” (%)
  handlePercent() {
    const value = parseFloat(this.displayValue);
    this.displayValue = String(value / 100);
  }

  // --- ç•Œé¢å¸ƒå±€ ---
  build() {
    Column() {
      // ç»“æœæ˜¾ç¤ºåŒºåŸŸ
      Column() {
        Text(this.displayValue)
          .width('100%')
          .padding({ right: 30 })
          .textAlign(TextAlign.End)
          .fontSize(80)
          .fontColor(Color.White)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.End)

      // æŒ‰é’®åŒºåŸŸ
      Column() {
        ForEach(this.buttonLayout, (row: string[]) => {
          Row() {
            ForEach(row, (label: string) => {
              Column() {
                CalculatorButton({
                  label: label,
                  btnBackgroundColor: this.getButtonColor(label),
                  fontColor: this.getFontColor(label),
                  //onPress: this.onButtonPress.bind(this),
                  // æ­£ç¡®çš„ ArkTS å†™æ³• (ç®­å¤´å‡½æ•°)
                  // âœ… æ­£ç¡®å†™æ³•ï¼šæ˜¾å¼å£°æ˜è¿”å›ç±»å‹ä¸º void
                  onPress: (label: string): void => this.onButtonPress(label),
                })
              }
              .layoutWeight(this.buttonLayout.indexOf(row) === 0 ? 1 : (label === '0' ? 2 : 1))
            }, (label: string) => label)
          }
          .width('100%')
          .aspectRatio(this.buttonLayout.indexOf(row) === 0 ? 5 : 4)
          .padding({ top: 5, bottom: 5 })
        }, (row: string[]) => row[0])
      }
      .width('100%')
      .padding(10)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
  }

  getButtonColor(label: string): Color {
    if (label === 'ğŸ¤“') {
      return 0xFF007AFF;
    } else if (['+', '-', 'Ã—', 'Ã·', '='].includes(label)) {
      return 0xFFFF9500;
    } else if (['AC', '+/-', '%'].includes(label)) {
      return 0xFFAFAFAF;
    } else {
      return 0xFF333333;
    }
  }

  getFontColor(label: string): Color {
    if (['ğŸ¤“','AC', '+/-', '%'].includes(label)) {
      return Color.Black;
    }
    return Color.White;
  }
}