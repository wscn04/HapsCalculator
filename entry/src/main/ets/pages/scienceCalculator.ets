import router from '@ohos.router';

// å®šä¹‰æŒ‰é’®ç‚¹å‡»å›è°ƒç±»å‹
type ButtonPressCallback = (label: string) => void;

// --- å¤ç”¨ä¹‹å‰çš„æŒ‰é’®ç»„ä»¶
@Component
struct ScientificButton {
  label: string = '0';
  btnBackgroundColor: Color = 0xFF333333;
  fontColor: Color = Color.White;
  onPress: ButtonPressCallback = (label: string) => {};

  build() {
    Button(this.label)
      .width('100%')
      .height('100%')
      .type(ButtonType.Normal)
      .fontSize(28)
      .fontColor(this.fontColor)
      .borderRadius(100)

      // æ ·å¼ä¸åŠ¨ç”»
      .stateStyles({
        normal: { .backgroundColor(this.btnBackgroundColor) },
        pressed: { .backgroundColor(this.getPressedColor()) }
      })
      .animation({ duration: 200, curve: Curve.EaseOut })
      .clickEffect({ level: ClickEffectLevel.LIGHT, scale: 0.95 })

      .onClick(() => {
        this.onPress(this.label);
      })
  }

  getPressedColor(): ResourceColor {
    if (this.btnBackgroundColor == 0xFFFF9500) return 0xFFCC7700;
    if (this.btnBackgroundColor == 0xFFAFAFAF) return 0xFF888888;
    if (this.btnBackgroundColor == 0xFF007AFF) return 0xFF0056B3; // è“è‰²æŒ‰ä¸‹å˜æ·±è“
    return 0xFF1A1A1A;
  }
}

@Entry
@Component
struct ScienceCalculator {
  @State displayValue: string = '0';

  // --- ç§‘å­¦è®¡ç®—å™¨å¸ƒå±€ (5 åˆ—) ---
  private buttonLayout: string[][] = [
    ['ğŸ§', '(', ')', 'C', 'Del'],
    ['sin', 'cos', 'tan', 'Ï€', 'Ã·'],
    ['7', '8', '9', 'âˆš', 'Ã—'],
    ['4', '5', '6', '^', '-'],
    ['1', '2', '3', 'e', '+'],
    ['0', '.', 'log', 'ln', '=']
  ];

  // --- æŒ‰é’®é€»è¾‘å¤„ç† ---
  onButtonPress(label: string) {
    if (label === 'ğŸ§') {
      // ğŸ”™ è¿”å›æ™®é€šè®¡ç®—å™¨
      router.back();
    } else if (label === 'C') {
      this.displayValue = '0';
    } else if (label === 'Del') {
      this.handleDelete();
    } else if (label === '=') {
      // æš‚æ—¶åªåšç®€å•çš„æ¨¡æ‹Ÿ
      this.displayValue = 'ğŸ¤¯ğŸ¤¯ğŸ¤¯';
    } else {
      this.handleInput(label);
    }
  }

  // è¾“å…¥å¤„ç†
  handleInput(label: string) {
    if (this.displayValue === '0' || this.displayValue === 'ğŸ¤¯ğŸ¤¯ğŸ¤¯') {
      this.displayValue = label;
    } else {
      this.displayValue += label;
    }
  }

  // åˆ é™¤å¤„ç†
  handleDelete() {
    if (this.displayValue.length > 1) {
      this.displayValue = this.displayValue.slice(0, -1);
    } else {
      this.displayValue = '0';
    }
  }

  build() {
    Column() {
      // 1. æ ‡é¢˜æ  (æ˜¾ç¤º "ç§‘å­¦æ¨¡å¼")
      Text('ç§‘å­¦æ¨¡å¼')
        .width('100%')
        .padding({ top: 10, left: 20 })
        .textAlign(TextAlign.Start)
        .fontSize(16)
        .fontColor(Color.Gray)

      // 2. ç»“æœæ˜¾ç¤ºåŒºåŸŸ
      Column() {
        Text(this.displayValue)
          .width('100%')
          .padding({ right: 20 })
          .textAlign(TextAlign.End)
          .fontSize(60)
          .fontColor(Color.White)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.End)
      .padding({ bottom: 20 })

      // 3. æŒ‰é’®åŒºåŸŸ
      Column() {
        ForEach(this.buttonLayout, (row: string[]) => {
          Row() {
            ForEach(row, (label: string) => {
              Column() {
                ScientificButton({
                  label: label,
                  btnBackgroundColor: this.getButtonColor(label),
                  fontColor: this.getFontColor(label),
                  onPress: (label: string): void => this.onButtonPress(label),
                })
              }
              .layoutWeight(1) // æ‰€æœ‰æŒ‰é’®ç­‰å®½
            }, (label: string) => label)
          }
          .width('100%')
          .aspectRatio(5.5) // è°ƒæ•´è¡Œé«˜ï¼Œç¨å¾®æ‰ä¸€ç‚¹ä»¥ä¾¿æ”¾ä¸‹æ›´å¤šè¡Œ
          .padding({ top: 3, bottom: 3 })
        }, (row: string[]) => row[0])
      }
      .width('100%')
      .padding(10)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
  }

  // --- é¢œè‰²é…ç½® ---
  getButtonColor(label: string): Color {
    if (label === 'Back') return 0xFF007AFF; // è¿”å›é”®ï¼šè“è‰²
    if (['C', 'Del'].includes(label)) return 0xFFAFAFAF; // åŠŸèƒ½é”®ï¼šæµ…ç°
    if (['+', '-', 'Ã—', 'Ã·', '=', '(', ')'].includes(label)) return 0xFFFF9500; // è¿ç®—ç¬¦ï¼šæ©™è‰²
    if (['sin', 'cos', 'tan', 'log', 'ln', 'Ï€', 'e', 'âˆš', '^'].includes(label)) return 0xFF222222; // ç§‘å­¦å‡½æ•°ï¼šæ›´æ·±çš„ç°è‰²
    return 0xFF333333; // æ•°å­—ï¼šæ·±ç°
  }

  getFontColor(label: string): Color {
    if (['C', 'Del'].includes(label)) return Color.Black;
    return Color.White;
  }
}